<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <title>Staff Chat | Concierge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0f0f1a;
      --bg-card: #1a1a2e;
      --bg-elevated: #252542;
      --accent: #c9a962;
      --accent-soft: rgba(201, 169, 98, 0.2);
      --text: #e8e6e3;
      --text-muted: #9a9aaa;
      --success: #4ade80;
      --radius: 16px;
      --radius-sm: 12px;
      --bubble-guest: #252542;
      --bubble-guest-border: rgba(201, 169, 98, 0.25);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: 0 0 env(safe-area-inset-bottom);
    }

    /* Chatbot header */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--bg-elevated);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-soft);
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    .header-text {
      flex: 1;
      min-width: 0;
    }
    .header h1 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 0.04em;
    }
    .header p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .header-logout {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-decoration: none;
      flex-shrink: 0;
    }
    .header-logout:hover { color: var(--accent); }
    .api-status {
      font-size: 0.65rem;
      opacity: 0.9;
    }
    .api-status.ok { color: var(--success); }
    .api-status.err { color: #f87171; }
    .chat-hint {
      padding: 12px 14px;
      margin: 10px 12px;
      background: var(--bg-elevated);
      border-radius: 14px;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-left: 4px solid var(--accent);
    }
    .chat-hint a { color: var(--accent); }
    .chat-hint code { background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }

    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px 80px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 24px;
      text-align: center;
    }
    .chat-empty-bot {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      margin-bottom: 16px;
    }

    /* Message row: guest message (left-aligned, chatbot style) */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 92%;
      animation: msgIn 0.3s ease;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(10px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .msg-bubble {
      background: var(--bubble-guest);
      border: 1px solid var(--bubble-guest-border);
      border-radius: 16px 16px 16px 4px;
      padding: 12px 14px;
      flex: 1;
      min-width: 0;
    }
    .msg-row.new .msg-bubble {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .msg-sender {
      font-size: 0.7rem;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 4px;
    }
    .msg-body {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .msg-icon {
      font-size: 1.5rem;
      line-height: 1;
    }
    .msg-labels {
      flex: 1;
      min-width: 0;
    }
    .msg-label-ja { font-size: 0.95rem; font-weight: 500; }
    .msg-label-en { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
    .msg-qty { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
    .msg-time {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 8px;
      opacity: 0.85;
    }

    /* Staff message (right-aligned) */
    .msg-row-staff {
      flex-direction: row-reverse;
    }
    .msg-row-staff .msg-bubble {
      border-radius: 16px 16px 4px 16px;
      background: var(--accent-soft);
      border-color: var(--accent);
    }
    .msg-row-staff .msg-sender { color: var(--accent); }

    /* Type message box */
    .chat-footer {
      position: sticky;
      bottom: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--bg-elevated);
      padding: 10px 12px 12px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .chat-input-wrap {
      flex: 1;
      min-width: 0;
    }
    .chat-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 20px;
      border: 1px solid var(--bg-elevated);
      background: var(--bg-elevated);
      color: var(--text);
      font: inherit;
      font-size: 0.95rem;
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }
    .chat-input::placeholder {
      color: var(--text-muted);
    }
    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }
    .chat-send {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: var(--accent);
      color: var(--bg-deep);
      font-size: 1.2rem;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .chat-send:hover {
      filter: brightness(1.1);
    }
    .chat-send:active {
      transform: scale(0.96);
    }
    .chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Status timeline (Uber/Grab style) */
    .request-status {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .status-timeline {
      display: flex;
      align-items: flex-start;
      gap: 0;
      margin-bottom: 10px;
    }
    .status-step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 0;
    }
    .status-step::before {
      content: '';
      position: absolute;
      top: 6px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--bg-elevated);
      z-index: 0;
    }
    .status-step:first-child::before { left: 50%; }
    .status-step:last-child::before { right: 50%; }
    .status-step.done::before { background: var(--accent); }
    .status-step.active::before { background: var(--accent); }
    .status-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 2px solid var(--bg-elevated);
      position: relative;
      z-index: 1;
      flex-shrink: 0;
    }
    .status-step.done .status-dot {
      background: var(--accent);
      border-color: var(--accent);
    }
    .status-step.active .status-dot {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .status-step.done .status-dot::after {
      content: '‚úì';
      position: absolute;
      inset: 0;
      font-size: 9px;
      color: var(--bg-deep);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .status-label {
      font-size: 0.6rem;
      color: var(--text-muted);
      margin-top: 4px;
      text-align: center;
      line-height: 1.2;
    }
    .status-step.done .status-label,
    .status-step.active .status-label { color: var(--accent); }
    .status-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .status-btn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--bg-elevated);
      background: var(--bg-elevated);
      color: var(--text);
      font: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .status-btn:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .status-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-avatar" aria-hidden="true">üè®</div>
    <div class="header-text">
      <h1>Concierge</h1>
      <p>Guest requests <span id="api-status" class="api-status"></span></p>
    </div>
    <a href="#" id="logout-link" class="header-logout" title="Log out">Log out</a>
  </header>

  <main class="chat" id="chat">
    <div class="chat-empty" id="chat-empty">
      <div class="chat-empty-bot">üí¨</div>
      No requests yet<br>
      <span style="font-size:0.8rem; margin-top:6px;">Requests will appear here when guests send</span>
    </div>
    <div class="chat-hint" id="chat-hint" style="display:none;"></div>
  </main>

  <footer class="chat-footer">
    <div class="chat-input-wrap">
      <textarea class="chat-input" id="chat-input" placeholder="Type a message..." rows="1"></textarea>
    </div>
    <button type="button" class="chat-send" id="chat-send" title="Send" aria-label="Send">‚û§</button>
  </footer>

  <script>
    (function () {
      var staffAuth = sessionStorage.getItem('staffAuth');
      var loginUrl = (location.origin && location.protocol !== 'file:')
        ? (location.origin + '/stafflogin.html')
        : 'stafflogin.html';
      if (!staffAuth) {
        location.replace(loginUrl);
        return;
      }

      const chatEl = document.getElementById('chat');
      const emptyEl = document.getElementById('chat-empty');
      const apiStatusEl = document.getElementById('api-status');
      const hintEl = document.getElementById('chat-hint');
      const POLL_INTERVAL_MS = 4000;
      let lastRequestCount = 0;
      let pollTimer = null;
      const API_BASE = (location.protocol === 'http:' || location.protocol === 'https:')
        ? location.origin
        : 'http://localhost:3001';
      const PRODUCTION_URL = 'https://concerige-v1.vercel.app';
      const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      const API_URL = isLocal ? (API_BASE + '/api/requests') : (API_BASE + '/api/concierge-edge?path=requests');
      const API_REQUEST = isLocal ? (API_BASE + '/api/request') : (API_BASE + '/api/concierge-edge?path=request');

      document.getElementById('logout-link').addEventListener('click', function (e) {
        e.preventDefault();
        sessionStorage.removeItem('staffAuth');
        location.href = loginUrl;
      });

      var STATUS_ORDER = [
        { key: 'sent', label: 'Sent', labelJa: 'ÈÄÅ‰ø°Ê∏à' },
        { key: 'read', label: 'Read', labelJa: 'Á¢∫Ë™çÊ∏à' },
        { key: 'on_the_way', label: 'On the way', labelJa: 'ÂØæÂøú‰∏≠' },
        { key: 'completed', label: 'Completed', labelJa: 'ÂÆå‰∫Ü' }
      ];
      function statusIndex(s) { return Math.max(0, STATUS_ORDER.findIndex(function (x) { return x.key === (s || 'sent'); })); }

      function formatTime(iso) {
        if (!iso) return '‚Äî';
        const d = new Date(iso);
        const now = new Date();
        const isToday = d.toDateString() === now.toDateString();
        if (isToday) {
          return d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }
        return d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) + ' ' +
          d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      }

      function renderStatusTimeline(r) {
        var cur = statusIndex(r.status);
        var steps = STATUS_ORDER.map(function (s, i) {
          var done = i < cur;
          var active = i === cur;
          var cls = 'status-step' + (done ? ' done' : '') + (active ? ' active' : '');
          return '<div class="' + cls + '"><div class="status-dot"></div><div class="status-label">' + s.label + '</div></div>';
        }).join('');
        var nextSteps = [];
        if (cur < 1) nextSteps.push({ status: 'read', label: 'Mark read' });
        if (cur < 2) nextSteps.push({ status: 'on_the_way', label: 'On the way' });
        if (cur < 3) nextSteps.push({ status: 'completed', label: 'Completed' });
        var btns = nextSteps.map(function (s) {
          return '<button type="button" class="status-btn" data-status="' + s.status + '">' + s.label + '</button>';
        }).join('');
        return '<div class="request-status">' +
          '<div class="status-timeline">' + steps + '</div>' +
          (btns ? '<div class="status-actions">' + btns + '</div>' : '') +
          '</div>';
      }

      function renderRequest(r) {
        const isNew = r.request_number > lastRequestCount;
        const icon = r.icon || 'üí¨';
        const qtyHtml = (r.quantity && r.quantity > 1)
          ? '<div class="msg-qty">Quantity: ' + r.quantity + '</div>' : '';
        var statusHtml = renderStatusTimeline(r);
        var reqStatus = r.status || 'sent';
        return (
          '<div class="msg-row' + (isNew ? ' new' : '') + '" data-id="' + (r.id || r.request_number) + '" data-status="' + reqStatus + '">' +
            '<div class="msg-avatar">' + icon + '</div>' +
            '<div class="msg-bubble">' +
              '<div class="msg-sender">Room ' + (r.room || '‚Äî') + ' ¬∑ #' + (r.request_number || '') + '</div>' +
              '<div class="msg-body">' +
                '<span class="msg-icon">' + icon + '</span>' +
                '<div class="msg-labels">' +
                  '<div class="msg-label-ja">' + (r.label_ja || r.label || '') + '</div>' +
                  '<div class="msg-label-en">' + (r.label_en || '') + '</div>' +
                  qtyHtml +
                '</div>' +
              '</div>' +
              '<div class="msg-time">' + formatTime(r.at) + '</div>' +
              statusHtml +
            '</div>' +
          '</div>'
        );
      }

      // Icon mapping for request_type (server stores label_ja/label_en)
      const ICON_MAP = {
        towels: 'üõÅ', pillows: 'üõèÔ∏è', toiletries: 'üß¥', water: 'ü•§', cleaning: 'üßπ',
        wakeup: '‚è∞', taxi: 'üöï', other: 'üí¨', laundry: 'üëï', iron: 'üëî', blanket: 'ü™ë',
        adapter: 'üîå', restaurant: 'üçΩÔ∏è', sightseeing: 'üó∫Ô∏è', luggage: 'üß≥'
      };
      function addIconToRequest(r) {
        r.icon = r.icon || ICON_MAP[r.request_type] || 'üí¨';
        return r;
      }

      function setApiStatus(msg, ok) {
        if (!apiStatusEl) return;
        apiStatusEl.textContent = msg;
        apiStatusEl.className = 'api-status ' + (ok ? 'ok' : 'err');
      }
      function showHint(html) {
        if (hintEl) {
          hintEl.innerHTML = html;
          hintEl.style.display = 'block';
        }
      }
      function hideHint() {
        if (hintEl) hintEl.style.display = 'none';
      }
      function fetchRequests() {
        fetch(API_URL)
          .then(function (res) {
            hideHint();
            setApiStatus('API ' + res.status, res.ok);
            if (!res.ok) throw new Error('API error');
            return res.json();
          })
          .then(function (data) {
            const requests = (data && data.requests) ? data.requests.map(addIconToRequest) : [];
            if (requests.length === 0) {
              emptyEl.style.display = 'flex';
              emptyEl.innerHTML = '<div class="chat-empty-bot">üí¨</div>No requests yet<br><span style="font-size:0.8rem; margin-top:6px;">Requests will appear here when guests send</span>';
              chatEl.querySelectorAll('.msg-row:not([data-staff])').forEach(function (n) { n.remove(); });
              return;
            }
            emptyEl.style.display = 'none';
            const existingIds = new Set();
            chatEl.querySelectorAll('.msg-row').forEach(function (n) {
              const id = n.getAttribute('data-id');
              if (id) existingIds.add(id);
            });
            const hadScrollBottom = chatEl.scrollHeight - chatEl.scrollTop <= chatEl.clientHeight + 50;
            requests.forEach(function (r) {
              const id = String(r.id || r.request_number || '');
              var row = chatEl.querySelector('.msg-row[data-id="' + id + '"]');
              if (row) {
                var currentStatus = row.getAttribute('data-status');
                var newStatus = r.status || 'sent';
                if (currentStatus !== newStatus) {
                  var block = row.querySelector('.request-status');
                  if (block) {
                    block.innerHTML = renderStatusTimeline(r);
                    row.setAttribute('data-status', newStatus);
                  }
                }
                existingIds.add(id);
                return;
              }
              existingIds.add(id);
              const wrap = document.createElement('div');
              wrap.innerHTML = renderRequest(r);
              const newRow = wrap.firstElementChild;
              if (newRow) {
                chatEl.appendChild(newRow);
                if ((r.status || 'sent') === 'sent') markAsReadIfSent(newRow, r);
              }
            });
            if (hadScrollBottom || (requests.length > 0 && (requests[requests.length - 1].request_number > lastRequestCount))) {
              chatEl.scrollTop = chatEl.scrollHeight;
            }
            var maxNum = lastRequestCount;
            requests.forEach(function (r) {
              var n = r.request_number;
              if (n != null && n > maxNum) maxNum = n;
            });
            lastRequestCount = maxNum;
          })
          .catch(function () {
            setApiStatus('Connection error', false);
            showHint(
              'Cannot connect to server.<br>' +
              'Run <code>node server.js</code> in terminal, or open<br>' +
              '<a href="' + PRODUCTION_URL + '/staff.html">' + PRODUCTION_URL + '/staff.html</a>'
            );
          });
      }

      function updateRequestStatus(rowEl, newStatus) {
        var id = rowEl.getAttribute('data-id');
        if (!id) return;
        var statusBlock = rowEl.querySelector('.request-status');
        if (!statusBlock) return;
        fetch(API_REQUEST, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, status: newStatus }),
        })
          .then(function (res) { return res.ok ? res.json() : Promise.reject(new Error('PATCH failed')); })
          .then(function () {
            statusBlock.innerHTML = renderStatusTimeline({ status: newStatus });
            rowEl.setAttribute('data-status', newStatus);
          })
          .catch(function () { setApiStatus('Update failed', false); });
      }

      function markAsReadIfSent(rowEl, request) {
        var id = rowEl.getAttribute('data-id');
        var status = (request && request.status) || 'sent';
        if (!id || status !== 'sent') return;
        fetch(API_REQUEST, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, status: 'read' }),
        })
          .then(function (res) { return res.ok ? res.json() : null; })
          .then(function () {
            var block = rowEl.querySelector('.request-status');
            if (block) {
              block.innerHTML = renderStatusTimeline({ status: 'read' });
              rowEl.setAttribute('data-status', 'read');
            }
          });
      }

      chatEl.addEventListener('click', function (e) {
        if (e.target.classList.contains('status-btn')) {
          var btn = e.target;
          var row = btn.closest('.msg-row');
          var status = btn.getAttribute('data-status');
          if (row && status) updateRequestStatus(row, status);
        }
      });

      function startPolling() {
        fetchRequests();
        pollTimer = setInterval(fetchRequests, POLL_INTERVAL_MS);
      }
      startPolling();

      window.addEventListener('visibilitychange', function () {
        if (document.visibilityState === 'visible') {
          fetchRequests();
          if (!pollTimer) startPolling();
        }
      });

      // Type message box: send staff message (local only)
      const inputEl = document.getElementById('chat-input');
      const sendBtn = document.getElementById('chat-send');
      let staffMsgCount = 0;
      function appendStaffMessage(text) {
        staffMsgCount += 1;
        const time = formatTime(new Date().toISOString());
        const row = document.createElement('div');
        row.className = 'msg-row msg-row-staff';
        row.setAttribute('data-staff', 'true');
        row.setAttribute('data-id', 'staff-' + staffMsgCount);
        row.innerHTML =
          '<div class="msg-avatar">üè®</div>' +
          '<div class="msg-bubble">' +
            '<div class="msg-sender">Staff</div>' +
            '<div class="msg-body">' +
              '<div class="msg-labels">' +
                '<div class="msg-label-ja" style="margin-top:0;">' + escapeHtml(text) + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="msg-time">' + time + '</div>' +
          '</div>';
        chatEl.appendChild(row);
        chatEl.scrollTop = chatEl.scrollHeight;
      }
      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function sendStaffMessage() {
        if (!inputEl) return;
        var text = (inputEl.value || '').trim();
        if (!text) return;
        appendStaffMessage(text);
        inputEl.value = '';
        inputEl.style.height = 'auto';
      }
      if (sendBtn) sendBtn.addEventListener('click', sendStaffMessage);
      if (inputEl) {
        inputEl.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendStaffMessage();
          }
        });
        inputEl.addEventListener('input', function () {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
      }
    })();
  </script>
</body>
</html>
