<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <title>Guest Chat | Concierge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0f0f1a;
      --bg-card: #1a1a2e;
      --bg-elevated: #252542;
      --accent: #c9a962;
      --accent-soft: rgba(201, 169, 98, 0.2);
      --text: #e8e6e3;
      --text-muted: #9a9aaa;
      --success: #4ade80;
      --radius: 16px;
      --radius-sm: 12px;
      --bubble-guest: #252542;
      --bubble-guest-border: rgba(201, 169, 98, 0.25);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: 0 0 env(safe-area-inset-bottom);
    }
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--bg-elevated);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-soft);
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    .header-text { flex: 1; min-width: 0; }
    .header h1 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 0.04em;
    }
    .header p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .header-link {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-decoration: none;
      flex-shrink: 0;
    }
    .header-link:hover { color: var(--accent); }
    .api-status { font-size: 0.65rem; opacity: 0.9; }
    .api-status.ok { color: var(--success); }
    .api-status.err { color: #f87171; }
    .chat-hint {
      padding: 12px 14px;
      margin: 10px 12px;
      background: var(--bg-elevated);
      border-radius: 14px;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-left: 4px solid var(--accent);
    }
    .chat-hint a { color: var(--accent); }
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px 24px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      padding: 24px;
      text-align: center;
    }
    .chat-empty-bot {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      margin-bottom: 16px;
    }
    .chat-empty a {
      color: var(--accent);
      margin-top: 16px;
      display: inline-block;
    }
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 92%;
      animation: msgIn 0.3s ease;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(10px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .msg-row-bot {
      align-self: flex-start;
    }
    .msg-row-bot .msg-bubble {
      border-radius: 16px 16px 16px 4px;
      background: var(--bg-elevated);
      border: 1px solid var(--bubble-guest-border);
    }
    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .msg-row-bot .msg-avatar { background: var(--accent-soft); }
    .msg-bubble {
      background: var(--bubble-guest);
      border: 1px solid var(--bubble-guest-border);
      border-radius: 16px 16px 16px 4px;
      padding: 12px 14px;
      flex: 1;
      min-width: 0;
    }
    .msg-sender {
      font-size: 0.7rem;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 4px;
    }
    .msg-body {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .msg-icon { font-size: 1.5rem; line-height: 1; }
    .msg-labels { flex: 1; min-width: 0; }
    .msg-label-ja { font-size: 0.95rem; font-weight: 500; }
    .msg-label-en { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
    .msg-qty { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
    .msg-time {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 8px;
      opacity: 0.85;
    }
    .request-status {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .status-timeline {
      display: flex;
      align-items: flex-start;
      gap: 0;
      margin-bottom: 0;
    }
    .status-step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 0;
    }
    .status-step::before {
      content: '';
      position: absolute;
      top: 6px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--bg-elevated);
      z-index: 0;
    }
    .status-step:first-child::before { left: 50%; }
    .status-step:last-child::before { right: 50%; }
    .status-step.done::before { background: var(--accent); }
    .status-step.active::before { background: var(--accent); }
    .status-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 2px solid var(--bg-elevated);
      position: relative;
      z-index: 1;
      flex-shrink: 0;
    }
    .status-step.done .status-dot {
      background: var(--accent);
      border-color: var(--accent);
    }
    .status-step.active .status-dot {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .status-step.done .status-dot::after {
      content: '‚úì';
      position: absolute;
      inset: 0;
      font-size: 9px;
      color: var(--bg-deep);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .status-label {
      font-size: 0.6rem;
      color: var(--text-muted);
      margin-top: 4px;
      text-align: center;
      line-height: 1.2;
    }
    .status-step.done .status-label,
    .status-step.active .status-label { color: var(--accent); }
    .chat-footer {
      background: var(--bg-card);
      border-top: 1px solid var(--bg-elevated);
      padding: 12px 16px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      text-align: center;
    }
    .chat-footer a {
      color: var(--accent);
      font-size: 0.9rem;
      text-decoration: none;
    }
    .chat-footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-avatar" aria-hidden="true">üè®</div>
    <div class="header-text">
      <h1 id="header-room">Room</h1>
      <p>Your request <span id="api-status" class="api-status"></span></p>
    </div>
    <a href="#" id="new-request-link" class="header-link">New request</a>
  </header>

  <main class="chat" id="chat">
    <div class="chat-empty" id="chat-empty">
      <div class="chat-empty-bot">üí¨</div>
      No request selected<br>
      <span style="font-size:0.8rem; margin-top:6px;">Open this page from the link after sending a request, or start a new one.</span>
      <a href="#" id="empty-link">Send a request</a>
    </div>
    <div class="chat-hint" id="chat-hint" style="display:none;"></div>
  </main>

  <footer class="chat-footer">
    <a href="#" id="footer-new-link">Send another request</a>
  </footer>

  <script>
    (function () {
      var origin = (location.origin && location.protocol !== 'file:') ? location.origin : '';
      var indexUrl = origin ? (origin + '/index.html') : 'index.html';
      document.getElementById('new-request-link').href = indexUrl;
      document.getElementById('empty-link').href = indexUrl;
      document.getElementById('footer-new-link').href = indexUrl;

      var params = new URLSearchParams(location.search || '');
      var id = params.get('id');
      var isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      var API_REQUEST = isLocal ? (origin + '/api/request') : (origin + '/api/concierge-edge?path=request');
      var POLL_MS = 4000;
      var pollTimer = null;

      var STATUS_ORDER = [
        { key: 'sent', label: 'Sent' },
        { key: 'read', label: 'Read' },
        { key: 'on_the_way', label: 'On the way' },
        { key: 'completed', label: 'Completed' }
      ];
      function statusIndex(s) {
        return Math.max(0, STATUS_ORDER.findIndex(function (x) { return x.key === (s || 'sent'); }));
      }
      function renderTimeline(status) {
        var cur = statusIndex(status);
        return STATUS_ORDER.map(function (s, i) {
          var done = i < cur;
          var active = i === cur;
          var cls = 'status-step' + (done ? ' done' : '') + (active ? ' active' : '');
          return '<div class="' + cls + '"><div class="status-dot"></div><div class="status-label">' + s.label + '</div></div>';
        }).join('');
      }

      var ICON_MAP = {
        towels: 'üõÅ', pillows: 'üõèÔ∏è', toiletries: 'üß¥', water: 'ü•§', cleaning: 'üßπ',
        wakeup: '‚è∞', taxi: 'üöï', other: 'üí¨', laundry: 'üëï', iron: 'üëî', blanket: 'ü™ë',
        adapter: 'üîå', restaurant: 'üçΩÔ∏è', sightseeing: 'üó∫Ô∏è', luggage: 'üß≥'
      };
      function formatTime(iso) {
        if (!iso) return '‚Äî';
        var d = new Date(iso);
        var now = new Date();
        var isToday = d.toDateString() === now.toDateString();
        if (isToday) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return d.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      function addIcon(r) {
        r.icon = r.icon || ICON_MAP[r.request_type] || 'üí¨';
        return r;
      }

      var chatEl = document.getElementById('chat');
      var emptyEl = document.getElementById('chat-empty');
      var apiStatusEl = document.getElementById('api-status');
      var hintEl = document.getElementById('chat-hint');

      function setApiStatus(msg, ok) {
        if (apiStatusEl) {
          apiStatusEl.textContent = msg;
          apiStatusEl.className = 'api-status ' + (ok ? 'ok' : 'err');
        }
      }
      function showHint(html) {
        if (hintEl) {
          hintEl.innerHTML = html;
          hintEl.style.display = 'block';
        }
      }
      function hideHint() {
        if (hintEl) hintEl.style.display = 'none';
      }

      function renderRequestRow(r) {
        addIcon(r);
        var icon = r.icon || 'üí¨';
        var qtyHtml = (r.quantity && r.quantity > 1) ? '<div class="msg-qty">Quantity: ' + r.quantity + '</div>' : '';
        var statusHtml = '<div class="request-status"><div class="status-timeline">' + renderTimeline(r.status || 'sent') + '</div></div>';
        return '<div class="msg-row" data-id="' + (r.id || '') + '">' +
          '<div class="msg-avatar">' + icon + '</div>' +
          '<div class="msg-bubble">' +
            '<div class="msg-sender">Request #' + (r.request_number || '') + (r.room ? ' ¬∑ Room ' + r.room : '') + '</div>' +
            '<div class="msg-body">' +
              '<span class="msg-icon">' + icon + '</span>' +
              '<div class="msg-labels">' +
                '<div class="msg-label-ja">' + (r.label_ja || r.label || '') + '</div>' +
                '<div class="msg-label-en">' + (r.label_en || '') + '</div>' +
                qtyHtml +
              '</div>' +
            '</div>' +
            '<div class="msg-time">' + formatTime(r.at) + '</div>' +
            statusHtml +
          '</div>' +
        '</div>';
      }

      function roomLabel(room) {
        return (room != null && room !== '') ? ('Room ' + room) : 'Room ‚Äî';
      }

      function renderBotMessage(text, botId, room) {
        var sender = roomLabel(room);
        var dataBot = botId ? ' data-bot="' + botId + '"' : ' data-bot="true"';
        return '<div class="msg-row msg-row-bot"' + dataBot + '>' +
          '<div class="msg-avatar">üè®</div>' +
          '<div class="msg-bubble">' +
            '<div class="msg-sender">' + sender + '</div>' +
            '<div class="msg-body"><div class="msg-labels"><div class="msg-label-ja">' + text + '</div></div></div>' +
          '</div>' +
        '</div>';
      }

      function updateHeaderAndBotSenders(room) {
        var headerRoom = document.getElementById('header-room');
        if (headerRoom) headerRoom.textContent = roomLabel(room);
        chatEl.querySelectorAll('.msg-row-bot .msg-sender').forEach(function (el) {
          el.textContent = roomLabel(room);
        });
      }

      function showRequest(request) {
        emptyEl.style.display = 'none';
        hideHint();
        setApiStatus('', true);
        var room = request.room != null && request.room !== '' ? request.room : null;
        updateHeaderAndBotSenders(room);
        var existing = chatEl.querySelector('.msg-row[data-id="' + request.id + '"]');
        if (existing) {
          var bubble = existing.querySelector('.msg-bubble');
          if (bubble) {
            var statusBlock = bubble.querySelector('.request-status');
            if (statusBlock) statusBlock.innerHTML = '<div class="status-timeline">' + renderTimeline(request.status || 'sent') + '</div>';
          }
          return;
        }
        var botRow = chatEl.querySelector('.msg-row[data-bot="true"]');
        if (!botRow) {
          var wrap = document.createElement('div');
          wrap.innerHTML = renderBotMessage('We\'ve received your request. Staff will assist you shortly‚Äîtrack status below.', null, room);
          if (wrap.firstElementChild) chatEl.insertBefore(wrap.firstElementChild, emptyEl);
        }
        var wrap2 = document.createElement('div');
        wrap2.innerHTML = renderRequestRow(request);
        var row = wrap2.firstElementChild;
        if (row) chatEl.appendChild(row);
        var botFooter = chatEl.querySelector('.msg-row[data-bot="footer"]');
        if (!botFooter) {
          var wrap3 = document.createElement('div');
          wrap3.innerHTML = renderBotMessage('Status updates automatically. Need something else? Use the link below.', 'footer', room);
          if (wrap3.firstElementChild) chatEl.appendChild(wrap3.firstElementChild);
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function showEmpty() {
        emptyEl.style.display = 'flex';
        chatEl.querySelectorAll('.msg-row').forEach(function (n) { n.remove(); });
        var headerRoom = document.getElementById('header-room');
        if (headerRoom) headerRoom.textContent = 'Room';
      }

      function fetchRequest() {
        if (!id) {
          showEmpty();
          return;
        }
        var url = API_REQUEST + (API_REQUEST.indexOf('?') >= 0 ? '&' : '?') + 'id=' + encodeURIComponent(id);
        fetch(url)
          .then(function (res) {
            hideHint();
            setApiStatus(res.ok ? 'Live' : 'Offline', res.ok);
            if (!res.ok) throw new Error('Not found');
            return res.json();
          })
          .then(function (data) {
            if (data && data.request) showRequest(data.request);
            else showEmpty();
          })
          .catch(function () {
            setApiStatus('‚Äî', false);
            showHint('Could not load request. <a href="' + indexUrl + '">Send a new request</a>');
          });
      }

      if (id) {
        fetchRequest();
        pollTimer = setInterval(fetchRequest, POLL_MS);
      } else {
        showEmpty();
      }
      document.addEventListener('visibilitychange', function () {
        if (document.visibilityState === 'visible' && id) fetchRequest();
      });
    })();
  </script>
</body>
</html>
